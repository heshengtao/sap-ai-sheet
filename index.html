<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SheetNext</title>
    <link rel="stylesheet" href="node_modules/sheetnext/dist/sheetnext.css">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        .loading { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; 
        }
        .error { color: red; padding: 20px; }
        .debug { 
            font-size: 12px; 
            color: #666; 
            margin-top: 10px; 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 4px; 
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>启动 SheetNext...</div>
        <div id="portInfo" style="font-size: 12px; color: #666;">正在解析扩展ID...</div>
    </div>

    <div id="SNContainer" style="width:100vw;height:100vh;padding:0 7px 7px;display:none;"></div>

    <script src="node_modules/sheetnext/dist/sheetnext.umd.js"></script>
    
    <script>
        function getCurrentExtId() {
            console.log('开始解析扩展ID...');
            
            // 方法1: 从当前页面 URL 解析
            // 期望的 URL 格式：http://localhost:port/extensions/ext_id/index.html
            // 或者：http://localhost:port/api/extensions/ext_id/...
            
            const currentUrl = window.location.href;
            const currentPath = window.location.pathname;
            
            console.log('当前URL:', currentUrl);
            console.log('当前路径:', currentPath);
            
            // 分割路径并过滤空字符串
            const pathParts = currentPath.split('/').filter(part => part.length > 0);
            console.log('路径部分:', pathParts);
            
            // 查找 'extensions' 关键词
            const extIndex = pathParts.indexOf('extensions');
            console.log('extensions索引位置:', extIndex);
            
            if (extIndex >= 0 && pathParts.length > extIndex + 1) {
                const extId = pathParts[extIndex + 1];
                console.log('从URL解析到的扩展ID:', extId);
                return extId;
            }
            
            // 方法2: 从 referrer (来源页面) 解析
            if (document.referrer) {
                console.log('尝试从referrer解析:', document.referrer);
                try {
                    const referrerUrl = new URL(document.referrer);
                    const referrerParts = referrerUrl.pathname.split('/').filter(part => part.length > 0);
                    const refExtIndex = referrerParts.indexOf('extensions');
                    
                    if (refExtIndex >= 0 && referrerParts.length > refExtIndex + 1) {
                        const extId = referrerParts[refExtIndex + 1];
                        console.log('从referrer解析到的扩展ID:', extId);
                        return extId;
                    }
                } catch (error) {
                    console.warn('解析referrer失败:', error);
                }
            }
            
            // 方法3: 从 URL hash 解析（如果有的话）
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                console.log('尝试从hash解析:', hash);
                if (hash.includes('ext_id=')) {
                    const extId = hash.split('ext_id=')[1].split('&')[0];
                    console.log('从hash解析到的扩展ID:', extId);
                    return extId;
                }
            }
            
            // 方法4: 从 URL 查询参数解析
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('ext_id')) {
                const extId = urlParams.get('ext_id');
                console.log('从查询参数解析到的扩展ID:', extId);
                return extId;
            }
            
            // 方法5: 尝试匹配常见的路径模式
            // 匹配类似 /static/extensions/ext_id/ 的路径
            const staticMatch = currentPath.match(/\/static\/extensions\/([^\/]+)/);
            if (staticMatch) {
                const extId = staticMatch[1];
                console.log('从static路径解析到的扩展ID:', extId);
                return extId;
            }
            
            // 匹配类似 /ext/ext_id/ 的路径
            const extMatch = currentPath.match(/\/ext\/([^\/]+)/);
            if (extMatch) {
                const extId = extMatch[1];
                console.log('从ext路径解析到的扩展ID:', extId);
                return extId;
            }
            
            console.warn('无法从URL解析扩展ID，使用默认值');
            return 'heshengtao_sap-sheetnext'; // 备用方案
        }

        async function init() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('SNContainer');
            const portInfo = document.getElementById('portInfo');
            
            try {
                // 动态获取 ext_id
                const extId = getCurrentExtId();
                
                // 构建 AI 服务地址
                const aiUrl = `/api/extensions/${extId}/node/sheetnextAI`;
                
                // 更新加载信息
                portInfo.textContent = `扩展ID: ${extId}`;
                
                console.log('初始化参数:', {
                    extId: extId,
                    aiUrl: aiUrl,
                    location: window.location.href,
                    referrer: document.referrer
                });

                // 检查 SheetNext 是否已加载
                if (typeof SheetNext === 'undefined') {
                    console.log('SheetNext 未加载，等待...');
                    setTimeout(init, 100);
                    return;
                }
                
                // 初始化 SheetNext
                container.style.display = 'block';
                const sn = new SheetNext(container, { 
                    AI_URL: aiUrl 
                });
                
                loading.style.display = 'none';
                console.log('✅ SheetNext 初始化成功');
                
            } catch (error) {
                console.error('❌ 初始化失败:', error);
                const extId = getCurrentExtId();
                const aiUrl = `/api/extensions/${extId}/node/sheetnextAI`;
                
                loading.innerHTML = `
                    <div class="error">
                        <h3>初始化失败</h3>
                        <p><strong>错误:</strong> ${error.message}</p>
                        <div class="debug">
                            <strong>调试信息:</strong><br>
                            扩展ID: ${extId}<br>
                            AI URL: ${aiUrl}<br>
                            当前URL: ${window.location.href}<br>
                            当前路径: ${window.location.pathname}<br>
                            来源页面: ${document.referrer || '无'}<br>
                            SheetNext可用: ${typeof SheetNext !== 'undefined'}
                        </div>
                        <button onclick="location.reload()">重试</button>
                        <button onclick="showDebugInfo()">显示详细调试</button>
                    </div>
                `;
            }
        }
        
        // 调试函数
        function showDebugInfo() {
            const extId = getCurrentExtId();
            const debugInfo = {
                扩展ID: extId,
                当前URL: window.location.href,
                当前路径: window.location.pathname,
                来源页面: document.referrer || '无',
                路径分割: window.location.pathname.split('/'),
                查询参数: Object.fromEntries(new URLSearchParams(window.location.search)),
                Hash: window.location.hash,
                SheetNext可用: typeof SheetNext !== 'undefined'
            };
            
            console.table(debugInfo);
            alert('调试信息已输出到控制台，请按F12查看');
        }
        
        // 确保页面完全加载后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // 添加全局调试函数
        window.debugExtension = showDebugInfo;
        window.getCurrentExtId = getCurrentExtId;
    </script>
</body>
</html>
